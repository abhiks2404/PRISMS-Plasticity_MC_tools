# PRISMS-PF_MC_tools
**Tools for integration between PRISMS-PF and Materials Commons**

The script files in this repository can be used to assist with automation of the following tasks:
- Locally importing PRISMS-PF code files and simulation results into a Materials Commons project directory
- For each calculation (simulation) directory, sorting the different file types into different subdirectories
- Creating a yaml file containing data and metadata for each simulation and adding these data to an ETL spreadsheet associated with an Experiment in Materials Commons
- Generating image frames and movies for different field variables within a phase-field simulation

To take full advantage of these tools you should:

1) [Create an account in Materials Commons](https://materialscommons.org/register) if you do not already have one
2) [Install and configure the Materials Commons Command Line Interface (CLI)](https://materials-commons.github.io/materials-commons-cli/html/install.html) in the  computer where you usually run PRISMS-PF.
3) Create a *project* directory in your computer to compile all the data files to be uploaded into a Materials Commons *project*. To be able to use the CLI, the name of the Materials Commons project should match that of the project locally. Read more about Materials Commons projects [here](https://materialscommons.org/docs/docs/getting-started/). It is recommended that the project directory is outside you phaseField directory.
4) Within the project directory, create a corresponding project within Materials Commons by typing
```
$ mc init
```

All of the scripts and commands below described below should be run under your **local project directory**.

**Creating a data log file for the simulation**

The script <code>importsim.sh</code> copies data from a source directory where the simulation code and results files are located into a new target directory (also called simulation directory) whithin your project directory
Usage
```
$ ./importsim.sh [--move_vtk] <source directory> [--rename] <target directory>
```
This will copy most of the contents of <code>\<source directory\></code> into <code>\<target directory\></code> but orgazing the files the following way

├── **project directory** <br>
           ├── **simulation directory** (target directory) <br>
                      ├── **code** <br>
                      ├── description.txt <br>
                      ├── observations.txt <br>
                      ├── **results** <br>
                                 ├── **images** <br>
                                 ├── **movies** <br>
                                 ├── **postprocess** <br>
                                 ├── **vtk** <br>

Options:

<code>--move_vtk</code>    Moves vtu or vtk files from <code>\<source directory\></code> to <code>\<target directory\></code> instead of copying them. This might be convenient to save space locally.

<code>--rename</code>      <code>\<target directory/></code>  If this option is not specified, the name of the <code>\<target directory\></code> will be the same as that of the <code>\<source directory\></code>.

**Generate Simulation data/metadata file**

The script <code>generate_yaml.py</code> parses the <code>parameters.prm</code> file, extracts key-value-type triples, and generates a yaml-type file with the data.
Usage
```
$ python generate_yaml.py <simulation directory> 
```
The script requires the python packages <code>re</code>, <code>ruamel</code>, and <code>argparse</code> to run. The yaml file (<code>simlog.yaml</code>) will be generated in the <code>\<simulation directory\></code>.

**Scripts to generate image frames and movies**

The script <code>plot_series.py</code> uses the LLNL [visit](https://www.visitusers.org/index.php?title=Using_CLI) CLI to generate 2D pseudocolor frames (in png format)from a series of simulation's vtu/vtk files at different time increments. The user can specify the fields for which to generate the frames.
Usage
```
$ python plot_series.py <var1> <var2> ... <simulation directory>
```
This script requires python packages <code>os</code>, <code>sys</code> and <code>visit</code>.

The script <code>make_movies.sh</code> uses the [ffmpeg](https://ffmpeg.org/) package to generate movies from the image series generated by <code>plot_series.py</code>.

Usage
```
$ ./make_movies.sh <var1> <var2> ... <simulation directory>
```
The list of variables, \<var1\> \<var2\> ... \<varN\>, must only include variables for which a set of images exist. 

**Script to generate ETL spreadsheet with simulation data**

The script <code>add_to_spreadsheet.py</code> does the following tasks:
1) Extract the simulation data and metadata from the file <code>\<simulation directory\></code><code>/simlog.yaml</code>.
2) Create an Excel file, <code>\<etl filename.xlsx\></code>, and write the simulation data in a single row, where each column corresponds to a different parameter.
3) If the file <code>\<etl filename.xlsx\></code> already exists, the script opens the file and appends the simulation data in the first unpopulated row.
4) Prompt the user for a description of the simulation and create the file <code>\<simulation directory\></code><code>/description.txt</code>. This file can be edited later or left empty.
5) Prompt the user for observations pertaining to the simulation and create the files file <code>\<simulation directory\></code><code>/observations.txt</code>. This file can be edited lateror left empty.
6) Write columns indicating the paths to the code files and simulation files relative to the project directory. This will facilitate access to the data when <code>add_to_spreadsheet.py</code> is associated with a Materials Commons Study (formerly known as 'Experiment').

Usage
```
$ python add_to_spreadsheet.py <simulation directory> <etl filename.xlsx>
```
This script requires python packages <code>os</code>, <code>sys</code> and <code>yaml</code>, and <code>pandas</code>.

After the steps above are carried out, all the simulation files and directories can be uploaded to Materials Commons under the remote directory
```
$ mc up -r .
```
This will essentially update the remote Materials Commons project with all the new files and subdirectories, without uploading existing files that have not been modified.
